# They Are Here — Implementation Complete

## What Changed

### 1. Rebrand: HEAT → They Are Here
- ✅ Updated all branding strings in HTML, JS, CSS, manifest, README
- ✅ Updated meta tags, titles, and header text
- ✅ Updated translations (EN, ES, PT)
- ✅ PWA manifest and app icons updated

### 2. Latest News Feed (Top Page)
- ✅ New export: `build/data/latest_news.json` (generated by `export_static.py`)
- ✅ Shows 8 most recent buffered items, sorted by last seen
- ✅ Displays headline, source, ZIP, priority badge, relative time
- ✅ Includes media links (up to 2 per item)
- ✅ Grid layout (responsive for mobile)
- ✅ Priority items (ZIP 07060) flagged with "Priority" chip

### 3. Alerts System Enhancements
- ✅ New `generate_cluster_alerts()` in `alerts.py` — creates buffered, ZIP-level alerts post-buffer
- ✅ 07060 priority: Automatic "high" priority flag for Plainfield central ZIP
- ✅ Alert payload includes: title, body, priority, tier, sources, size, volume_score
- ✅ Exports to `build/data/alerts.json` (frontend reads this)
- ✅ Validates alert text against `FORBIDDEN_ALERT_WORDS` before emission

### 4. AWS SNS SMS Notifier (`notifier.py`)
- ✅ New module: `processing/notifier.py`
- ✅ Uses AWS SNS free tier to send SMS
- ✅ Rate limiting: 1 alert per ZIP per hour (prevents spam)
- ✅ Formats alerts to 160 chars (SMS limit)
- ✅ Only sends "high" priority alerts when `ENABLE_SMS_ALERTS=true`
- ✅ Logs sent alerts to `data/tracking/sms_sent.json`
- ✅ Test function: `send_test_sms('+12345678901')`

**Setup:**
```bash
# Install boto3
pip install boto3

# Set AWS credentials
export AWS_ACCESS_KEY_ID="your_key"
export AWS_SECRET_ACCESS_KEY="your_secret"
export AWS_REGION="us-east-1"

# Set subscriber phone numbers (comma-separated, E.164 format)
export SNS_PHONE_NUMBERS="+12345678901,+10987654321"

# Enable SMS alerts
export ENABLE_SMS_ALERTS=true

# Test SMS
python -c "from processing.notifier import send_test_sms; send_test_sms('+12345678901')"
```

### 5. Location-Aware Alert Banner (Frontend)
- ✅ New banner element at top of main section
- ✅ Shows alert for user's ZIP (from geolocation or saved preference)
- ✅ Displays priority label (Priority vs. Buffered)
- ✅ Hides when no alert or no ZIP detected
- ✅ Triggers when user clicks location button or on page load if ZIP saved
- ✅ Styling: glass card with left border accent

### 6. Twitter/X Integration (`twitter_scraper.py`)
- ✅ New module: `processing/twitter_scraper.py`
- ✅ Uses Twitter API v2 (free tier: 500k tweets/month Essential, 10k Elevated)
- ✅ Monitors NJ civic accounts: ACLU NJ, NJ.com, Governor Murphy, etc.
- ✅ Searches hashtags: #ImmigrationNJ, #PlaintfieldNJ, #SanctuaryNJ, etc.
- ✅ Filters by keywords (immigration, ICE, sanctuary, etc.)
- ✅ Extracts ZIP from text or user location
- ✅ Normalizes to CSV format (text, zip, date, source)
- ✅ Saves to `data/raw/twitter_YYYYMMDD_HHMMSS.csv`
- ✅ Respects rate limits (2s delay between requests)

**Setup:**
```bash
# Get Twitter API credentials
1. Go to https://developer.x.com
2. Sign in with Twitter account
3. Create a new Project and App
4. Generate a Bearer Token (easiest for read-only)
   OR: Get API Key, API Secret, Access Token, Access Secret

# Set environment variable
export X_BEARER_TOKEN="your_bearer_token_here"

# Run scraper
python processing/twitter_scraper.py

# Output: data/raw/twitter_YYYYMMDD_HHMMSS.csv
```

**Alternative: OAuth 1.0a (if using API v1.1):**
```bash
export X_API_KEY="your_api_key"
export X_API_SECRET="your_api_secret"
export X_ACCESS_TOKEN="your_access_token"
export X_ACCESS_SECRET="your_access_secret"
```

---

## How to Use

### Running the Full Pipeline with Twitter
```batch
# Windows
scripts\run_pipeline.bat

# Or manually with Twitter scraping:
cd processing
python twitter_scraper.py
python rss_scraper.py
python ingest.py
python cluster.py
python nlp_analysis.py
python heatmap.py
python buffer.py
python export_static.py
python alerts.py
python tiers.py
```

### Testing SMS Alerts
```bash
# Set environment variables (see above)
export ENABLE_SMS_ALERTS=true

# Run alert engine
python processing/alerts.py

# Or test directly
python -c "from processing.notifier import send_test_sms; send_test_sms('+12345678901', 'Test from They Are Here')"
```

### Testing Twitter Scraper
```bash
# Set bearer token
export X_BEARER_TOKEN="your_token"

# Run scraper
python processing/twitter_scraper.py

# Check output
ls data/raw/twitter_*.csv
head data/raw/twitter_YYYYMMDD_HHMMSS.csv
```

---

## Data Flow

```
RSS feeds + Twitter API
    ↓
ingest.py (normalize to text/zip/date)
    ↓
cluster.py (HDBSCAN semantic clustering)
    ↓
nlp_analysis.py (keywords, trends, burst detection)
    ↓
buffer.py (safety thresholds: 24hr delay, 3+ sources, 2+ distinct)
    ↓
export_static.py (clusters.json, latest_news.json)
    ↓
alerts.py (pattern alerts + cluster alerts → alerts.json)
    ↓
notifier.py (send SMS if ENABLE_SMS_ALERTS=true)
    ↓
tiers.py (tier0_public.json, tier1_contributor.json, tier2_moderator.json)
    ↓
Frontend displays: clusters, timeline, latest news, location alert
```

---

## Safety & Buffer Rules (Unchanged)

All alerts and news items **must pass buffer thresholds**:
- ✅ 24-hour minimum delay (72hr for Tier 0 public)
- ✅ 3+ signals per cluster
- ✅ 2+ distinct sources (corroboration required)
- ✅ Volume score ≥ 0.7
- ✅ No forbidden alert words (presence, sighting, activity, etc.)

07060 priority alerts still respect buffer—they're just flagged for faster notification after thresholds are met.

---

## Next Steps / Optional Enhancements

1. **Email alerts**: Extend `notifier.py` to send via AWS SES or SNS email topic
2. **Push notifications**: Use service worker + Push API for browser notifications
3. **Twitter automation**: Run `twitter_scraper.py` on cron/GitHub Actions hourly
4. **SMS opt-in form**: Build a web form for users to subscribe (store in S3 or DynamoDB)
5. **Alert dashboard**: Admin page showing sent alerts, rate limits, subscriber counts
6. **Twitter API v1.1 fallback**: If v2 rate limits are hit, implement OAuth 1.0a flow
7. **Mastodon/Bluesky**: Extend to federated social networks for broader NJ coverage

---

## Environment Variables Reference

```bash
# AWS SNS (for SMS alerts)
AWS_ACCESS_KEY_ID="your_key"
AWS_SECRET_ACCESS_KEY="your_secret"
AWS_REGION="us-east-1"  # default
SNS_PHONE_NUMBERS="+12345678901,+10987654321"
ENABLE_SMS_ALERTS="true"

# Twitter/X API
X_BEARER_TOKEN="your_bearer_token"
# OR (for v1.1/OAuth 1.0a):
X_API_KEY="your_api_key"
X_API_SECRET="your_api_secret"
X_ACCESS_TOKEN="your_access_token"
X_ACCESS_SECRET="your_access_secret"
```

---

## Files Modified/Created

**Modified:**
- `build/index.html` — Rebrand, add alert banner + latest news section
- `build/app.js` — Rebrand, fetch alerts/latest_news, render banner + feed
- `build/styles.css` — Rebrand comment, add alert/news styles
- `build/mobile.css` — Rebrand comment, tighten alert/news for mobile
- `build/manifest.json` — Rebrand name, description, screenshot
- `README.md` — Update heading to "They Are Here"
- `processing/export_static.py` — Add latest_news.json export
- `processing/alerts.py` — Add cluster alert generation, rebrand, SMS integration

**Created:**
- `processing/notifier.py` — AWS SNS SMS sender
- `processing/twitter_scraper.py` — Twitter/X API v2 scraper
- `IMPLEMENTATION_NOTES.md` — This file

---

## Testing Checklist

- [ ] Run pipeline end-to-end: `scripts\run_pipeline.bat`
- [ ] Check `build/data/latest_news.json` exists and has items
- [ ] Check `build/data/alerts.json` exists and has cluster_alerts
- [ ] Open `build/index.html` in browser, verify rebrand to "They Are Here"
- [ ] Verify latest news feed displays at top
- [ ] Use browser geolocation, verify alert banner shows (if alerts exist for ZIP)
- [ ] Set `X_BEARER_TOKEN`, run `python processing/twitter_scraper.py`, check CSV output
- [ ] Set AWS credentials + SNS phone, run `python processing/alerts.py`, verify SMS sent (if enabled)
- [ ] Test SMS: `python -c "from processing.notifier import send_test_sms; send_test_sms('+1234567890')"`

---

## Deployment

No changes to deployment scripts needed. Just:

1. Run pipeline locally to generate new JSONs
2. Deploy to S3: `scripts\deploy_s3.bat`
3. CloudFront will serve updated files

If using GitHub Actions, add secrets for `X_BEARER_TOKEN`, `AWS_ACCESS_KEY_ID`, etc.

---

**Implementation complete!** All requested features delivered:
1. ✅ Rebrand to "They Are Here"
2. ✅ Latest news feed at top (buffered)
3. ✅ 07060 automatic priority alerts (post-buffer)
4. ✅ AWS SNS SMS notifications (free tier)
5. ✅ Location-aware alert banner
6. ✅ Twitter/X ingestion with API key guidance
